# BUG-011: booking_state overwritten to not_bookable by API failure

**Severity:** Critical
**Status:** Fixed
**Found in:** QA Phase 1 — Ground Truth (30-profile cohort)
**Spec reference:** Quick Spec §3.1 `booking_state`, `online_bookable` fields
**Date:** 2026-02-28

---

## Description

When the booking API call fails (e.g. HTTP 401 — no API key configured), the catch block in `runBookingStage()` unconditionally writes `booking_state: "not_bookable"` to the database. This overwrites the page-detected bookable state from the parse stage, even though the page clearly showed a booking iframe with available slots.

## Evidence

Profile `mr-piers-moreau`:
- **Live page**: Full booking calendar visible with slots on March 11, 14, April 1
- **DB `online_bookable`**: 1 (correctly detected from page)
- **DB `booking_state`**: "not_bookable" (incorrectly overwritten by API failure)

This contradiction exists for 22 of 30 profiles where `online_bookable = 1` but `booking_state = "not_bookable"`.

## Root Cause

`run.ts`, line ~253 in the catch block of `runBookingStage()`:

```typescript
catch (error) {
  upsertConsultant(runId, slug, {
    booking_state: "not_bookable",  // <-- unconditional overwrite
    available_slots_next_28_days: 0,
    ...
  });
}
```

The catch block hard-codes `"not_bookable"` regardless of what the page showed. The `onlineBookable` parameter is already available in scope but unused.

## Fix

Use the page-detected bookability to set an appropriate fallback state:

```typescript
catch (error) {
  const fallbackState = onlineBookable ? "bookable_no_slots" : "not_bookable";
  upsertConsultant(runId, slug, {
    booking_state: fallbackState,
    available_slots_next_28_days: 0,
    ...
  });
}
```

This preserves the fact that the page showed a booking widget, even though the API couldn't confirm specific slot data.

## Design Note

This is partly a design issue — without the API key, the booking stage will always fail. But the fix ensures that page-detected bookability is never lost due to a transient API error, which is the correct behaviour even when the API is available.

## Regression Tests

- API failure + page shows booking iframe → booking_state = "bookable_no_slots"
- API failure + page has no booking iframe → booking_state = "not_bookable"
