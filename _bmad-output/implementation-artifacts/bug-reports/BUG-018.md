# BUG-018: Specialty scoring ignores sub-specialties and creates conflicting tier signals

**Severity:** High  
**Status:** Fixed  
**Found by:** ROG  
**Affected areas:** Consultant detail page score breakdown and tier display  
**Spec reference:** Section 3.2 specialty fields (`specialty_primary`, `specialty_sub`) and Section 3.4 tiering
**Date:** 2026-02-28

## Symptom

A consultant can show clear specialty evidence in the profile (for example, non-empty `specialty_sub` and clinical specialty content) but still receive:

- `Specialty Defined: 0/10`
- `Quality Tier: Incomplete`
- Score gauge label showing a score-based tier such as `Gold`

This produces a contradictory user experience on a single page.

## Reproduction Example

- Consultant: `Mr Jamie O'Callaghan`
- Registration number: `7285390`
- Stored data includes non-empty `specialty_sub` and clinical interests
- `specialty_primary` is empty
- Result shown in UI: score `80`, quality tier `Incomplete`, specialty dimension `0/10`

## Root Cause

1. Scoring logic for specialty points and tier gating checks only `specialty_primary`
2. UI score breakdown "Specialty Defined" also checks only `specialty_primary`
3. Score gauge renders an independent score-to-tier label that can conflict with canonical `quality_tier`

## Planned Fix

- Treat specialty as defined when either `specialty_primary` or `specialty_sub` is non-empty
- Apply the same combined rule in deterministic tier gating
- Update score breakdown logic to match
- Remove score-gauge tier label so `Quality Tier` card remains the single source of truth

## Validation Plan

- Add/update unit tests for sub-specialty-only profiles
- Confirm consultants with empty `specialty_primary` and non-empty `specialty_sub` receive specialty points and valid non-Incomplete tiers when otherwise eligible
- Confirm consultant page no longer shows conflicting tier labels

## Regression Tests

- `src/scraper/score.test.ts`: "should treat sub-specialties as valid specialty evidence for scoring and tier gates"
- `src/scraper/score.test.ts`: updated specialty gate test to require both `specialty_primary` and `specialty_sub` to be empty

## Files Changed

- `src/scraper/score.ts` - specialty scoring and tier gating now use combined specialty evidence (`specialty_primary` or `specialty_sub`)
- `src/scraper/run.ts` - passes `specialty_sub` into score input
- `src/app/consultants/[slug]/compute-score.ts` - "Specialty Defined" now awards points when either specialty field is populated
- `src/components/ui/score-gauge.tsx` - removed secondary tier label from score gauge to prevent contradiction with canonical `Quality Tier`
- `src/scraper/score.test.ts` - added and updated regression tests
