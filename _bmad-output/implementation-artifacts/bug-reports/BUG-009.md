# BUG-009: patient_age_restriction parsing completely broken

**Severity:** Critical
**Status:** Fixed
**Found in:** QA Phase 1 — Ground Truth (30-profile cohort)
**Spec reference:** Quick Spec §3.1 `patient_age_restriction` field
**Date:** 2026-02-28

---

## Description

Age restriction values are garbled for the majority of profiles that have them. The extracted text and min/max values are nonsensical, matching phone numbers, postcodes, and other unrelated numeric patterns in the page body text.

## Affected Profiles

| Slug | Extracted Value | min | max | Live Page Shows |
|------|----------------|-----|-----|-----------------|
| mr-piers-moreau | "002-200" | 2 | 200 | No age restriction |
| dr-mark-austin | "30 - 20" | 30 | 20 | Not verified |
| dr-sam-firoozi | "30 - 8" | 30 | 8 | Not verified |
| mr-edward-saxby | "30 - 17" | 30 | 17 | Not verified |
| dr-laurie-windsor | "from 201" | 201 | null | No age restriction |
| dr-doddaiah-hanumantharaya | "10 - 12" | 10 | 12 | Not verified |
| dr-paras-dalal | "17-19" | 17 | 19 | Not verified |
| ms-kallirroi-tzafetta | "00-17" | 0 | 17 | Not verified |
| professor-christof-kastner | "00 to 20" | 0 | 20 | Not verified |

Only 2 of 11 non-null values look plausible: `"only sees adults"` and `"from the ages of 0 to 18"`.

## Root Cause

Three compounding problems in `extractAgeRestriction()` (`parse.ts`, line ~817):

1. **Search scope too broad**: `$("body").text()` concatenates ALL text nodes across the entire DOM with no separators. Phone numbers, addresses, postcodes, dates, and prices all bleed together into a single string.

2. **Regex preamble is optional**: `AGE_RANGE_REGEX` (line ~93) has `(?:from\s+...)?` making the entire preamble optional. This degenerates to `\d{1,3}\s*[-to]\s*\d{1,3}` — matching ANY two numbers separated by a hyphen. Phone numbers like `01743 282500` concatenated with address text produce false matches.

3. **No semantic validation**: min > max values (30 > 8, 30 > 17, 30 > 20) are accepted without sanity checks.

Example: `"002-200"` comes from a phone number's last digits + a hyphen + address number.

## Fix

1. Scope search to short candidate elements (`<p>`, `<li>`) containing age-related keywords instead of full body text
2. Make the range regex preamble non-optional (require "ages", "age", or similar keyword)
3. Add sanity check: reject if min > max or max > 120
4. Consider searching only within the heading-identified age restriction section

## Regression Tests

- Body text with phone numbers and no age restriction → returns null
- Body text with "from the ages of 5 to 16" → correctly extracts min=5, max=16
- Body text with "only sees adults" → correctly extracts min=18
